import{s as n,w as _}from"./index-ea234c37.js";class x{static async getDailyDashboard(a){try{const{data:r,error:t}=await n.from("v_daily_dashboard").select("*").eq("report_date",a).maybeSingle();if(t&&t.code!=="PGRST116")throw t;return r}catch(r){throw new Error(_(r))}}static async getTeamSummaries(){try{const{data:a,error:r}=await n.from("v_team_summary").select("*");if(r)throw r;return a}catch(a){throw new Error(_(a))}}static async getCustomerHistories(){try{const{data:a,error:r}=await n.from("v_customer_history").select("*").order("total_orders",{ascending:!1});if(r)throw r;return a}catch(a){throw new Error(_(a))}}static async getWorkerStats(){try{const{data:a,error:r}=await n.from("v_worker_stats").select("*").order("completed_orders",{ascending:!1});if(r)throw r;return a}catch(a){throw new Error(_(a))}}static async generateDailyReport(a,r){try{const{data:t,error:l}=await n.from("orders").select("status, total_amount, customer_rating").eq("scheduled_date",a);if(l)throw l;const{data:c,error:d}=await n.from("expenses").select("amount, status").gte("created_at",`${a}T00:00:00`).lte("created_at",`${a}T23:59:59`);if(d)throw d;const{data:e,error:s}=await n.from("teams").select("id").eq("is_active",!0);if(s)throw s;const o=(t==null?void 0:t.length)||0,p=(t==null?void 0:t.filter(i=>i.status==="completed").length)||0,g=(t==null?void 0:t.filter(i=>i.status==="cancelled").length)||0,h=(t==null?void 0:t.filter(i=>i.status==="completed").reduce((i,w)=>i+(w.total_amount||0),0))||0,u=(c==null?void 0:c.filter(i=>i.status==="approved").reduce((i,w)=>i+(w.amount||0),0))||0,m=h-u,y=(e==null?void 0:e.length)||0,f=(t==null?void 0:t.filter(i=>i.customer_rating).reduce((i,w,T,S)=>i+(w.customer_rating||0)/S.length,0))||0,b={report_date:a,total_orders:o,completed_orders:p,cancelled_orders:g,total_revenue:h,total_expenses:u,net_profit:m,active_teams:y,average_rating:f,generated_by:r},{data:D,error:v}=await n.from("daily_reports").upsert(b).select().single();if(v)throw v;return{success:!0,data:D,message:"تم إنشاء التقرير اليومي بنجاح"}}catch(t){return{success:!1,error:_(t)}}}static async getDailyReport(a){try{const{data:r,error:t}=await n.from("daily_reports").select("*").eq("report_date",a).single();if(t&&t.code!=="PGRST116")throw t;return r}catch(r){throw new Error(_(r))}}static async getDailyReports(a,r){try{const{data:t,error:l}=await n.from("daily_reports").select("*").gte("report_date",a).lte("report_date",r).order("report_date",{ascending:!1});if(l)throw l;return t||[]}catch(t){throw new Error(_(t))}}static async getDashboardStats(){try{const a=new Date().toISOString().split("T")[0],{data:r}=await n.from("orders").select("status, total_amount, customer_rating").eq("scheduled_date",a),{data:t}=await n.from("orders").select("id").eq("status","pending"),{data:l}=await n.from("routes").select("id").eq("date",a).eq("status","in_progress"),c=new Date(new Date().getFullYear(),new Date().getMonth(),1).toISOString().split("T")[0],d=new Date(new Date().getFullYear(),new Date().getMonth()+1,0).toISOString().split("T")[0],{data:e}=await n.from("orders").select("total_amount").gte("scheduled_date",c).lte("scheduled_date",d).eq("status","completed"),{data:s}=await n.from("expenses").select("amount").gte("created_at",`${c}T00:00:00`).lte("created_at",`${d}T23:59:59`).eq("status","approved"),{data:o}=await n.from("teams").select("id").eq("is_active",!0),p=(e==null?void 0:e.reduce((u,m)=>u+(m.total_amount||0),0))||0,g=(s==null?void 0:s.reduce((u,m)=>u+(m.amount||0),0))||0,h=(r==null?void 0:r.filter(u=>u.customer_rating).reduce((u,m,y,f)=>u+(m.customer_rating||0)/f.length,0))||0;return{today_orders:(r==null?void 0:r.length)||0,pending_orders:(t==null?void 0:t.length)||0,active_routes:(l==null?void 0:l.length)||0,total_revenue:p,total_expenses:g,net_profit:p-g,active_teams:(o==null?void 0:o.length)||0,average_rating:h}}catch(a){throw new Error(_(a))}}static async getRevenueChartData(a=30){try{const r=new Date,t=new Date(r.getTime()-a*24*60*60*1e3),{data:l,error:c}=await n.from("daily_reports").select("report_date, total_revenue, total_expenses").gte("report_date",t.toISOString().split("T")[0]).lte("report_date",r.toISOString().split("T")[0]).order("report_date");if(c)throw c;const d=(l||[]).map(o=>o.report_date),e=(l||[]).map(o=>o.total_revenue),s=(l||[]).map(o=>o.total_expenses);return{labels:d,datasets:[{label:"الإيرادات",data:e,backgroundColor:["rgba(34, 197, 94, 0.2)"],borderColor:["rgba(34, 197, 94, 1)"]},{label:"المصروفات",data:s,backgroundColor:["rgba(239, 68, 68, 0.2)"],borderColor:["rgba(239, 68, 68, 1)"]}]}}catch(r){throw new Error(_(r))}}static async getOrdersStatusChartData(a,r){try{let t=n.from("orders").select("status");a&&(t=t.gte("scheduled_date",a)),r&&(t=t.lte("scheduled_date",r));const{data:l,error:c}=await t;if(c)throw c;const d=(l||[]).reduce((s,o)=>(s[o.status]=(s[o.status]||0)+1,s),{}),e={pending:"معلق",scheduled:"مجدول",in_progress:"قيد التنفيذ",completed:"مكتمل",cancelled:"ملغي"};return{labels:Object.keys(d).map(s=>e[s]||s),datasets:[{label:"عدد الطلبات",data:Object.values(d),backgroundColor:["rgba(251, 191, 36, 0.8)","rgba(59, 130, 246, 0.8)","rgba(168, 85, 247, 0.8)","rgba(34, 197, 94, 0.8)","rgba(239, 68, 68, 0.8)"]}]}}catch(t){throw new Error(_(t))}}static async getTeamPerformanceComparison(a,r){try{let t=n.from("orders").select(`
          team_id,
          status,
          total_amount,
          customer_rating,
          team:teams(name)
        `).not("team_id","is",null);a&&(t=t.gte("scheduled_date",a)),r&&(t=t.lte("scheduled_date",r));const{data:l,error:c}=await t;if(c)throw c;const d=(l||[]).reduce((e,s)=>{var g;const o=s.team_id,p=((g=s.team)==null?void 0:g.name)||"فريق غير محدد";return e[o]||(e[o]={name:p,total_orders:0,completed_orders:0,total_revenue:0,total_rating:0,rating_count:0}),e[o].total_orders++,s.status==="completed"&&(e[o].completed_orders++,e[o].total_revenue+=s.total_amount||0),s.customer_rating&&(e[o].total_rating+=s.customer_rating,e[o].rating_count++),e},{});return Object.values(d).map(e=>({team_name:e.name,total_orders:e.total_orders,completed_orders:e.completed_orders,completion_rate:e.total_orders>0?e.completed_orders/e.total_orders*100:0,total_revenue:e.total_revenue,average_rating:e.rating_count>0?e.total_rating/e.rating_count:0}))}catch(t){throw new Error(_(t))}}static async getMonthlySummary(a,r){try{const t=new Date(a,r-1,1).toISOString().split("T")[0],l=new Date(a,r,0).toISOString().split("T")[0],{data:c,error:d}=await n.from("daily_reports").select("*").gte("report_date",t).lte("report_date",l).order("report_date");if(d)throw d;const e=(c||[]).reduce((s,o)=>({total_orders:s.total_orders+o.total_orders,completed_orders:s.completed_orders+o.completed_orders,cancelled_orders:s.cancelled_orders+o.cancelled_orders,total_revenue:s.total_revenue+o.total_revenue,total_expenses:s.total_expenses+o.total_expenses,net_profit:s.net_profit+o.net_profit,total_rating:s.total_rating+o.average_rating*o.completed_orders,rating_count:s.rating_count+o.completed_orders}),{total_orders:0,completed_orders:0,cancelled_orders:0,total_revenue:0,total_expenses:0,net_profit:0,total_rating:0,rating_count:0});return{...e,average_rating:e.rating_count>0?e.total_rating/e.rating_count:0,completion_rate:e.total_orders>0?e.completed_orders/e.total_orders*100:0,profit_margin:e.total_revenue>0?e.net_profit/e.total_revenue*100:0,daily_reports:c}}catch(t){throw new Error(_(t))}}}export{x as R};
